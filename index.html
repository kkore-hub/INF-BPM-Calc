<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IIDX INF BPM Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", "Meiryo", "Malgun Gothic", sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 25px;
            padding-top: 20px;
        }

        /* èªè¨€åˆ— */
        .lang-bar {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .lang-btn {
            padding: 5px 10px;
            font-size: 0.85rem;
            border: 1px solid #ddd;
            background: #fff;
            border-radius: 15px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }
        .lang-btn.active {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
            font-weight: bold;
        }

        h1 {
            text-align: center;
            font-size: 1.4rem; /* ç¨å¾®ç¸®å°ä¸€é»å­—é«”ä»¥é©æ‡‰è¼ƒé•·çš„æ¨™é¡Œ */
            font-weight: 800;
            color: #2c3e50;
            margin: 10px 0 20px 0;
            line-height: 1.4;
        }

        /* æ¨™ç±¤èˆ‡æç¤º */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.95rem;
            color: #555;
            line-height: 1.4;
        }
        
        .equiv-hint {
            font-size: 0.9rem;
            color: #d35400;
            font-weight: bold;
            display: inline-block;
            margin-left: 0; 
        }
        .step1-hint-block {
            display: block;
            margin-top: 4px;
            margin-bottom: 4px;
        }

        /* --- å…¨åŸŸè¨­å®šå€ (é ‚éƒ¨) --- */
        .global-section {
            background: #fff8e1;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffecb3;
            margin-bottom: 25px;
        }
        .global-row {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        /* ä¿®æ”¹ï¼šBPM è¼¸å…¥æ¡†æ”¹ç‚ºå›ºå®šå¯¬åº¦ï¼Œç¯€çœç©ºé–“çµ¦é¸å–® */
        .global-input {
            width: 110px;       /* çµ¦äºˆå›ºå®šå¯¬åº¦ï¼Œå¤ é¡¯ç¤º3ä½æ•¸å³å¯ */
            flex: none;         /* ä¸åƒèˆ‡å½ˆæ€§ä¼¸ç¸® */
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.4rem;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }
        .global-input:focus {
            border-color: #d35400;
            outline: none;
        }
        
        /* ä¿®æ”¹ï¼šé¸å–®ä½”æ»¿å‰©é¤˜ç©ºé–“ */
        select.type-select {
            flex: 1;            /* ä½”æ“šå‰©é¤˜æ‰€æœ‰ç©ºé–“ */
            width: 100%;        /* ç¢ºä¿å¯¬åº¦å¡«æ»¿ */
            min-width: 0;       /* é˜²æ­¢å…§å®¹éé•·çˆ†æ¡† */
            padding: 10px 5px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: white;
            font-size: 0.95rem;
            color: #333;
            text-overflow: ellipsis; /* æ–‡å­—éé•·é¡¯ç¤º... */
        }

        /* åˆ†éš”ç·š */
        .divider {
            height: 1px;
            background: #eee;
            margin: 20px 0;
        }

        h2 {
            font-size: 1.1rem;
            border-left: 5px solid #3498db;
            padding-left: 10px;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* è¼¸å…¥å€ */
        .input-row {
            display: flex;
            gap: 8px;
        }
        input.sub-input {
            /* ä¸‹æ–¹ç›®æ¨™ BPM ä¹Ÿå¥—ç”¨åŒæ¨£é‚è¼¯ï¼Œè®“é¸å–®ç©ºé–“å¤§ä¸€é» */
            flex: 1; 
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1.1rem;
            box-sizing: border-box;
            min-width: 80px;
        }

        /* æŒ‰éˆ• */
        button.action-btn {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: background 0.2s;
        }
        button.action-btn:active {
            background-color: #2980b9;
        }

        /* çµæœé¢æ¿ */
        .result-panel {
            background: #eef7ff;
            border: 1px solid #b3d7ff;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        .big-number {
            font-size: 2.2rem;
            font-weight: 800;
            color: #e74c3c;
            display: block;
            margin: 5px 0;
        }
        .warning-text {
            color: #c0392b;
            font-weight: bold;
            font-size: 0.95rem;
            margin-top: 4px;
            display: block;
        }

        /* æ»‘æ¡¿å€ */
        .slider-wrapper {
            background: #fafafa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            text-align: center;
        }
        .speed-display {
            font-size: 1.8rem;
            font-weight: 800;
            color: #2c3e50;
        }
        .base-ref {
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
        }
        input[type="range"] {
            width: 100%;
            margin: 15px 0;
            cursor: pointer;
            height: 8px;
        }

        /* è¡¨æ ¼ */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
            color: #666;
            font-size: 0.85rem;
        }
        .val-col {
            text-align: right;
            font-weight: bold;
            font-family: monospace;
            font-size: 1.1rem;
        }
        tr.highlight-row {
            background-color: #fff8e1;
        }
        tr.highlight-row td {
            color: #d35400;
        }

        .footer-credit {
            margin-top: 30px;
            text-align: center;
            font-size: 0.75rem;
            color: #aaa;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="lang-bar">
        <button class="lang-btn active" onclick="setLang('tw')">ç¹é«”ä¸­æ–‡</button>
        <button class="lang-btn" onclick="setLang('jp')">æ—¥æœ¬èª</button>
        <button class="lang-btn" onclick="setLang('kr')">í•œêµ­ì–´</button>
        <button class="lang-btn" onclick="setLang('en')">English</button>
    </div>

    <h1 id="txt_title">IIDX INF PLAY SPEED & BPM è¨ˆç®—å™¨</h1>

    <div class="global-section">
        <label>
            <span id="lbl_base">ğŸµ è«‹å…ˆè¼¸å…¥ åŸå§‹æ­Œæ›² BPM èˆ‡ éŸ³ç¬¦å¯†åº¦ä¸»é«”</span>
            <br>
            <span id="base_equiv_display" class="equiv-hint step1-hint-block"></span>
        </label>
        <div class="global-row">
            <input type="number" id="baseBpm" class="global-input" value="255" inputmode="numeric">
            <select id="baseType" class="type-select" onchange="updateDisplays()">
                <option value="1.0" class="opt-16">16åˆ†éŸ³ (é è¨­)</option>
                <option value="0.5" class="opt-8">8åˆ†éŸ³ (æ…¢)</option>
                <option value="0.666666" class="opt-12" selected>12åˆ†éŸ³ (ä¸‰é€£éŸ³)</option>
                <option value="1.333333" class="opt-24">24åˆ†éŸ³ (å…­é€£éŸ³)</option>
            </select>
        </div>
    </div>

    <h2 id="txt_h_target">A. PLAY SPEED æ›ç®—</h2>
    <label>
        <span id="lbl_target">ç›®æ¨™ç·´ç¿’ BPM</span>
        <span id="target_equiv_display" class="equiv-hint"></span>
    </label>
    <div class="input-row">
        <input type="number" id="targetBpm" class="sub-input" placeholder="ä¾‹å¦‚: 180" inputmode="numeric">
        <select id="targetType" class="type-select" onchange="updateDisplays()">
            <option value="1.0" class="opt-16" selected>16åˆ†éŸ³ (é è¨­)</option>
            <option value="0.5" class="opt-8">8åˆ†éŸ³</option>
            <option value="0.666666" class="opt-12">12åˆ†éŸ³ (ä¸‰é€£éŸ³)</option>
            <option value="1.333333" class="opt-24">24åˆ†éŸ³ (å…­é€£éŸ³)</option>
        </select>
    </div>
    
    <button class="action-btn" id="btn_calc" onclick="calculateGoal()">è¨ˆç®—æœ€ä½³å€ç‡ (Play Speed)</button>

    <div class="result-panel" id="calcResult" style="display:none;">
        <div id="txt_suggest">å»ºè­°è¨­å®š Play Speed</div>
        <span class="big-number" id="suggestedSpeed">1.00</span>
        <div id="limitWarning" class="warning-text" style="display:none;"></div>
        <div id="suggestedActual" style="margin-top:8px;">æ›ç®—å¾Œå¯¦éš›åŸå§‹BPM: -</div>
    </div>

    <div class="divider"></div>

    <h2 id="txt_h_sim">B. å„éŸ³ç¬¦å¯†åº¦èˆ‡PLAY SPEEDæ¨¡æ“¬</h2>
    <div class="slider-wrapper">
        <label id="lbl_slider">æ‰‹å‹•èª¿æ•´ Speed</label>
        <div class="speed-display" id="currentSpeedDisplay">1.00</div>
        <div class="base-ref" id="txt_base_ref">(Base: -)</div>
        
        <input type="range" id="speedSlider" min="0" max="16" step="1" value="6" oninput="updateDensityTable()">
        
        <div style="font-size:0.95rem; color:#555;">
            <span id="lbl_curr_actual">æ›ç®—å¾Œå¯¦éš›åŸå§‹BPM</span>: 
            <span id="currentActualBpm" style="color:#2c3e50; font-weight:800; font-size:1.2rem;">-</span>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th id="th_type">éŸ³ç¬¦å¯†åº¦</th>
                <th id="th_equiv" style="text-align:right;">ç­‰æ•ˆ 16åˆ†éŸ³</th>
            </tr>
        </thead>
        <tbody>
            <tr class="highlight-row">
                <td id="row_16">16åˆ†éŸ³ (æ¨™æº–)</td>
                <td class="val-col" id="val-16">-</td>
            </tr>
            <tr>
                <td id="row_8">8åˆ†éŸ³</td>
                <td class="val-col" id="val-8">-</td>
            </tr>
            <tr>
                <td id="row_12">12åˆ†éŸ³ (ä¸‰é€£éŸ³)</td>
                <td class="val-col" id="val-12">-</td>
            </tr>
            <tr>
                <td id="row_24">24åˆ†éŸ³ (å…­é€£éŸ³)</td>
                <td class="val-col" id="val-24">-</td>
            </tr>
        </tbody>
    </table>

    <div class="footer-credit">
        Created by KKORE using Gemini 3 | Version 251127
    </div>
</div>

<script>
    // --- å¤šèªç³»è¨­å®š ---
    const i18n = {
        tw: {
            title: "IIDX INF PLAY SPEED & BPM è¨ˆç®—å™¨",
            lbl_base: "ğŸµ è«‹å…ˆè¼¸å…¥ åŸå§‹æ­Œæ›² BPM èˆ‡ éŸ³ç¬¦å¯†åº¦ä¸»é«”",
            h_target: "A. PLAY SPEED æ›ç®—",
            lbl_target: "ç›®æ¨™ç·´ç¿’ BPM",
            btn_calc: "è¨ˆç®—æœ€ä½³å€ç‡ (Play Speed)",
            txt_suggest: "å»ºè­°è¨­å®š Play Speed",
            txt_actual_res: "æ›ç®—å¾Œå¯¦éš›åŸå§‹BPM: ",
            txt_diff_prefix: "è·é›¢ç›®æ¨™BPM",
            h_sim: "B. å„éŸ³ç¬¦å¯†åº¦èˆ‡PLAY SPEEDæ¨¡æ“¬",
            lbl_slider: "æ‰‹å‹•èª¿æ•´ Play Speed",
            lbl_curr_actual: "æ›ç®—å¾Œå¯¦éš›åŸå§‹BPM",
            th_type: "éŸ³ç¬¦å¯†åº¦é¡å‹",
            th_equiv: "ç­‰æ•ˆ 16åˆ†éŸ³ BPM",
            row_16: "16åˆ†éŸ³ (æ¨™æº–)",
            row_8: "8åˆ†éŸ³",
            row_12: "12åˆ†éŸ³ (ä¸‰é€£éŸ³)",
            row_24: "24åˆ†éŸ³ (å…­é€£éŸ³)",
            opt_16: "16åˆ†éŸ³ (é è¨­)",
            opt_8: "8åˆ†éŸ³",
            opt_12: "12åˆ†éŸ³ (ä¸‰é€£éŸ³)",
            opt_24: "24åˆ†éŸ³ (å…­é€£éŸ³)",
            alert_msg: "è«‹å…ˆè¼¸å…¥ã€ŒåŸå§‹æ­Œæ›² BPMã€å’Œã€Œç›®æ¨™ BPMã€",
            equiv_prefix: "â‰ˆ å¯¦è³ªBPM: ",
            warn_max: "å·²è¶…éä¸Šé™",
            warn_min: "å·²ä½æ–¼ä¸‹é™"
        },
        jp: {
            title: "IIDX INF PLAY SPEED & BPM è¨ˆç®—æ©Ÿ",
            lbl_base: "ğŸµ å…ƒã®BPMã¨éŸ³ç¬¦ã‚¿ã‚¤ãƒ—ã‚’å…¥åŠ›",
            h_target: "A. PLAY SPEED æ›ç®—",
            lbl_target: "ç›®æ¨™BPM",
            btn_calc: "æœ€é©å€ç‡ã‚’è¨ˆç®—",
            txt_suggest: "æ¨å¥¨ãƒ—ãƒ¬ã‚¤ã‚¹ãƒ”ãƒ¼ãƒ‰",
            txt_actual_res: "æ›ç®—å¾Œã®å®Ÿè³ªBPM: ",
            txt_diff_prefix: "ç›®æ¨™BPMã¨ã®å·®",
            h_sim: "B. éŸ³ç¬¦ã‚¿ã‚¤ãƒ—ã¨PLAY SPEEDã®æ¨¡æ“¬",
            lbl_slider: "å€ç‡èª¿æ•´ (Play Speed)",
            lbl_curr_actual: "æ›ç®—å¾Œã®å®Ÿè³ªBPM",
            th_type: "éŸ³ç¬¦ã‚¿ã‚¤ãƒ—",
            th_equiv: "16åˆ†éŸ³ç¬¦æ›ç®—",
            row_16: "16åˆ†éŸ³ç¬¦ (æ¨™æº–)",
            row_8: "8åˆ†éŸ³ç¬¦",
            row_12: "12åˆ†éŸ³ç¬¦ (3é€£ç¬¦)",
            row_24: "24åˆ†éŸ³ç¬¦ (6é€£ç¬¦)",
            opt_16: "16åˆ†éŸ³ç¬¦ (æ¨™æº–)",
            opt_8: "8åˆ†éŸ³ç¬¦",
            opt_12: "12åˆ†éŸ³ç¬¦ (3é€£ç¬¦)",
            opt_24: "24åˆ†éŸ³ç¬¦ (6é€£ç¬¦)",
            alert_msg: "å…ƒã®BPMã¨ç›®æ¨™BPMã‚’å…¥åŠ›ã—ã¦ãã ã•ã„",
            equiv_prefix: "â‰ˆ å®Ÿè³ªBPM: ",
            warn_max: "ä¸Šé™ã‚’è¶…ãˆã¾ã—ãŸ",
            warn_min: "ä¸‹é™ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ"
        },
        kr: {
            title: "IIDX INF PLAY SPEED & BPM ê³„ì‚°ê¸°",
            lbl_base: "ğŸµ ê¸°ë³¸ BPM ë° ë…¸íŠ¸ ì¢…ë¥˜ ì…ë ¥",
            h_target: "A. PLAY SPEED í™˜ì‚°",
            lbl_target: "ëª©í‘œ BPM",
            btn_calc: "ìµœì  ë°°ì† ê³„ì‚°",
            txt_suggest: "ì¶”ì²œ í”Œë ˆì´ ì†ë„",
            txt_actual_res: "í™˜ì‚° í›„ ì‹¤ì œ BPM: ",
            txt_diff_prefix: "ëª©í‘œ BPMê³¼ì˜ ì°¨ì´",
            h_sim: "B. ë…¸íŠ¸ ì¢…ë¥˜ ë° PLAY SPEED ì‹œë®¬ë ˆì´ì…˜",
            lbl_slider: "í”Œë ˆì´ ì†ë„ ì¡°ì ˆ",
            lbl_curr_actual: "í™˜ì‚° í›„ ì‹¤ì œ BPM",
            th_type: "ë…¸íŠ¸ ë°€ë„",
            th_equiv: "16ë¹„íŠ¸ í™˜ì‚° BPM",
            row_16: "16ë¹„íŠ¸ (í‘œì¤€)",
            row_8: "8ë¹„íŠ¸",
            row_12: "12ë¹„íŠ¸ (3ì—°ìŒ)",
            row_24: "24ë¹„íŠ¸ (6ì—°ìŒ)",
            opt_16: "16ë¹„íŠ¸ (í‘œì¤€)",
            opt_8: "8ë¹„íŠ¸",
            opt_12: "12ë¹„íŠ¸ (3ì—°ìŒ)",
            opt_24: "24ë¹„íŠ¸ (6ì—°ìŒ)",
            alert_msg: "ê¸°ë³¸ BPMê³¼ ëª©í‘œ BPMì„ ì…ë ¥í•´ì£¼ì„¸ìš”",
            equiv_prefix: "â‰ˆ ì‹¤ì§ˆ BPM: ",
            warn_max: "ìµœëŒ€ ì†ë„ ì´ˆê³¼",
            warn_min: "ìµœì†Œ ì†ë„ ë¯¸ë§Œ"
        },
        en: {
            title: "IIDX INF PLAY SPEED & BPM Calculator",
            lbl_base: "ğŸµ Enter Base BPM & Note Type",
            h_target: "A. PLAY SPEED Calculation",
            lbl_target: "Target BPM",
            btn_calc: "Calculate Best Speed",
            txt_suggest: "Best Play Speed",
            txt_actual_res: "Converted Base BPM: ",
            txt_diff_prefix: "Diff from Target",
            h_sim: "B. Density & Speed Simulation",
            lbl_slider: "Adjust Play Speed",
            lbl_curr_actual: "Converted Base BPM",
            th_type: "Note Type",
            th_equiv: "Equiv. 16th BPM",
            row_16: "16th Note (Standard)",
            row_8: "8th Note",
            row_12: "12th Note (Triplets)",
            row_24: "24th Note (Sextuplets)",
            opt_16: "16th Note (Std)",
            opt_8: "8th Note",
            opt_12: "12th Note (Triplets)",
            opt_24: "24th Note (Sextuplets)",
            alert_msg: "Please enter Base BPM and Target BPM",
            equiv_prefix: "â‰ˆ Effective BPM: ",
            warn_max: "Upper Limit Exceeded",
            warn_min: "Below Lower Limit"
        }
    };

    let currentLang = 'tw';

    // 0.70 ~ 1.50
    const speeds = [];
    for(let i=70; i<=150; i+=5) {
        speeds.push(i/100);
    }

    // DOM Elements
    const baseBpmInput = document.getElementById('baseBpm');
    const baseTypeSelect = document.getElementById('baseType');
    const targetBpmInput = document.getElementById('targetBpm');
    const targetTypeSelect = document.getElementById('targetType');
    const slider = document.getElementById('speedSlider');
    const displaySpeed = document.getElementById('currentSpeedDisplay');
    const displayActual = document.getElementById('currentActualBpm');
    const baseRefText = document.getElementById('txt_base_ref');
    const baseEquivDisplay = document.getElementById('base_equiv_display');
    const targetEquivDisplay = document.getElementById('target_equiv_display');
    const limitWarning = document.getElementById('limitWarning');

    window.onload = function() {
        setLang('tw');
        updateDisplays(); 
        updateDensityTable();
    };

    // Listeners
    baseBpmInput.addEventListener('input', () => { updateDisplays(); autoRecalc(); updateDensityTable(); });
    baseTypeSelect.addEventListener('change', () => { updateDisplays(); autoRecalc(); });
    targetBpmInput.addEventListener('input', () => { updateDisplays(); });
    targetTypeSelect.addEventListener('change', () => { updateDisplays(); });

    function autoRecalc() {
        if(document.getElementById('calcResult').style.display !== 'none') {
            calculateGoal(false);
        }
    }

    function updateDisplays() {
        const t = i18n[currentLang];
        
        // Base
        const baseVal = parseFloat(baseBpmInput.value);
        const baseRatio = parseFloat(baseTypeSelect.value);
        if(baseVal && baseRatio) {
            if(Math.abs(baseRatio - 1.0) > 0.01) {
                const equiv = baseVal * baseRatio;
                baseEquivDisplay.textContent = `${t.equiv_prefix}${equiv.toFixed(1)}`;
            } else {
                baseEquivDisplay.textContent = "";
            }
        } else {
            baseEquivDisplay.textContent = "";
        }

        // Target
        const targetVal = parseFloat(targetBpmInput.value);
        const targetRatio = parseFloat(targetTypeSelect.value);
        if(targetVal && targetRatio) {
             if(Math.abs(targetRatio - 1.0) > 0.01) {
                const equiv = targetVal * targetRatio;
                targetEquivDisplay.textContent = `(${t.equiv_prefix}${equiv.toFixed(1)})`;
            } else {
                targetEquivDisplay.textContent = "";
            }
        } else {
            targetEquivDisplay.textContent = "";
        }
    }

    function setLang(lang) {
        currentLang = lang;
        const t = i18n[lang];

        document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
        const btnIdx = {'tw':0, 'jp':1, 'kr':2, 'en':3};
        document.querySelectorAll('.lang-btn')[btnIdx[lang]].classList.add('active');

        // Texts
        document.getElementById('txt_title').textContent = t.title;
        document.getElementById('lbl_base').textContent = t.lbl_base;
        document.getElementById('txt_h_target').textContent = t.h_target;
        document.getElementById('lbl_target').textContent = t.lbl_target;
        document.getElementById('btn_calc').textContent = t.btn_calc;
        document.getElementById('txt_suggest').textContent = t.txt_suggest;
        document.getElementById('txt_h_sim').textContent = t.h_sim;
        document.getElementById('lbl_slider').textContent = t.lbl_slider;
        document.getElementById('lbl_curr_actual').textContent = t.lbl_curr_actual;
        document.getElementById('th_type').textContent = t.th_type;
        document.getElementById('th_equiv').textContent = t.th_equiv;
        document.getElementById('row_16').textContent = t.row_16;
        document.getElementById('row_8').textContent = t.row_8;
        document.getElementById('row_12').textContent = t.row_12;
        document.getElementById('row_24').textContent = t.row_24;

        updateSelectText(baseTypeSelect, t);
        updateSelectText(targetTypeSelect, t);
        updateDisplays();

        if(document.getElementById('calcResult').style.display !== 'none') {
             calculateGoal(false);
        }
    }

    function updateSelectText(selectEl, t) {
        selectEl.querySelector('.opt-16').innerText = t.opt_16;
        selectEl.querySelector('.opt-8').innerText = t.opt_8;
        selectEl.querySelector('.opt-12').innerText = t.opt_12;
        selectEl.querySelector('.opt-24').innerText = t.opt_24;
    }

    function calculateGoal(moveSlider = true) {
        const base = parseFloat(baseBpmInput.value);
        const baseRatio = parseFloat(baseTypeSelect.value);
        const target = parseFloat(targetBpmInput.value);
        const targetRatio = parseFloat(targetTypeSelect.value);
        const t = i18n[currentLang];

        if (!base || !target) {
            if(moveSlider) alert(t.alert_msg);
            return;
        }

        const effectiveBase = base * baseRatio;
        const effectiveTarget = target * targetRatio;
        const rawRatio = effectiveTarget / effectiveBase; // è¨ˆç®—åŸå§‹éœ€æ±‚çš„å€ç‡
        
        let bestSpeed = 1.0;
        let warningMsg = "";
        
        if (rawRatio > 1.50) {
            bestSpeed = 1.50;
            warningMsg = t.warn_max;
        } else if (rawRatio < 0.70) {
            bestSpeed = 0.70;
            warningMsg = t.warn_min;
        } else {
            let bestDiff = 999;
            let bestIndex = 6;
            for(let i=0; i<speeds.length; i++) {
                let diff = Math.abs(speeds[i] - rawRatio);
                if(diff < bestDiff) {
                    bestDiff = diff;
                    bestIndex = i;
                }
            }
            bestSpeed = speeds[bestIndex];
        }

        const resultPanel = document.getElementById('calcResult');
        resultPanel.style.display = 'block';
        document.getElementById('suggestedSpeed').textContent = bestSpeed.toFixed(2);
        
        if(warningMsg) {
            limitWarning.style.display = 'block';
            limitWarning.textContent = warningMsg;
        } else {
            limitWarning.style.display = 'none';
        }

        const actualDensity = effectiveBase * bestSpeed;
        const diffVal = actualDensity - effectiveTarget;
        const audioBpm = base * bestSpeed;

        document.getElementById('suggestedActual').innerHTML = 
            `${t.txt_actual_res}${audioBpm.toFixed(1)} <br>` + 
            `<span style="font-size:0.9rem; color:#666;">` +
            `(${t.txt_diff_prefix} ${diffVal > 0 ? '+' : ''}${diffVal.toFixed(1)})` + 
            `</span>`;

        if(moveSlider) {
            let targetIdx = speeds.findIndex(s => Math.abs(s - bestSpeed) < 0.001);
            if(targetIdx !== -1) {
                slider.value = targetIdx;
                updateDensityTable();
            }
        }
    }

    function updateDensityTable() {
        const idx = parseInt(slider.value);
        const currentSpeed = speeds[idx];
        
        displaySpeed.textContent = currentSpeed.toFixed(2);
        const base = parseFloat(baseBpmInput.value);
        
        if(base) {
            baseRefText.textContent = `(Base: ${base})`;
        } else {
            baseRefText.textContent = "(Base: -)";
        }

        if(!base) {
            displayActual.textContent = "-";
            ['val-16','val-8','val-12','val-24'].forEach(id => document.getElementById(id).textContent = "-");
            return;
        }

        const audioBpm = base * currentSpeed;
        displayActual.textContent = audioBpm.toFixed(1);

        document.getElementById('val-16').textContent = (audioBpm * 1.0).toFixed(1);
        document.getElementById('val-8').textContent  = (audioBpm * 0.5).toFixed(1);
        document.getElementById('val-12').textContent = (audioBpm * (2/3)).toFixed(1);
        document.getElementById('val-24').textContent = (audioBpm * (4/3)).toFixed(1);
    }
</script>

</body>
</html>
